@startuml Apply Updates Sequence Diagram
actor User
participant "HomeView" as View
participant "HomePresenter" as Presenter
participant "RemoteUpdateService" as Update
participant "AsyncJob" as Job
participant "ExecutionService" as Exec
participant "DriverMatchingService" as Matcher
participant "DialogPresenter" as Dialog

User -> View: Clicks "Apply Updates"
View -> Presenter: OnSearch()
activate Presenter

alt Multiple hosts entered
    Presenter -> Dialog: ShowConfirmation("Apply updates to N hosts?")
    Dialog --> Presenter: true/false
end

loop For each hostname
    Presenter -> Presenter: StartProcess("PC-01")
    
    Presenter -> Update: PrepareScanForUpdates("PC-01")
    activate Update
    Update -> Update: ValidateHostConnectivity("PC-01")
    Update -> Update: BuildWorkerArgs("PC-01", "Scan", {})
    Update --> Presenter: JobParams (scriptPath, arguments)
    deactivate Update

    Presenter -> Job: new AsyncJob("PC-01", "UpdateScan")
    Presenter -> Job: Start(scriptPath, arguments, configPath)
    activate Job
    ... Job executes ExecutionService.StartWorker() ...
    Job -> Exec: StartWorker("PC-01", "Scan", ...)
    Exec -> Exec: RunScanPhase(device)
    Exec --> Job: ScanResults
    Presenter -> Job: Poll()
    Job --> Presenter: Status = "Completed"
    deactivate Job

    Presenter -> Update: ParseUpdateReport("PC-01")
    activate Update
    Update -> Matcher: FindBestDriverMatch(updates, drivers)
    Matcher --> Update: MatchedUpdates
    Update --> Presenter: UpdateList
    deactivate Update

    alt Updates Available
        Presenter -> Dialog: ShowUpdateConfirmation(UpdateList)
        activate Dialog
        Dialog -> User: Show Update Popup
        User --> Dialog: Confirms
        Dialog --> Presenter: Confirmed
        deactivate Dialog
        
        Presenter -> Update: PrepareApplyUpdates("PC-01", selectedUpdates)
        activate Update
        Update -> Update: BuildWorkerArgs("PC-01", "Apply", selectedUpdates)
        Update --> Presenter: JobParams
        deactivate Update
        
        Presenter -> Job: new AsyncJob("PC-01", "UpdateApply")
        Presenter -> Job: Start(scriptPath, arguments, configPath)
        activate Job
        ... Job executes ExecutionService.StartWorker() ...
        Job -> Exec: StartWorker("PC-01", "Apply", options, ...)
        Exec -> Exec: RunApplyPhase(device, options)
        Exec --> Job: ApplyResults
        Presenter -> Job: Poll()
        Job --> Presenter: Status = "Completed"
        deactivate Job
        
        Presenter -> Presenter: Add to ManualRebootQueue if needed
        Presenter -> View: UpdateStatus("Updates Applied")
    else No Updates
        Presenter -> View: UpdateStatus("No Updates Found")
    end
end

opt Manual Reboot Queue not empty
    Presenter -> View: Display reboot required hosts
end
@enduml
