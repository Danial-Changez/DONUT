@startuml Self-Update Sequence Diagram
actor User
participant "UpdatePresenter" as Presenter
participant "SelfUpdateService" as Service
participant "GitHub API" as GH
participant "InstallWorker.ps1" as Worker

User -> Presenter: Clicks "Check for Updates"
activate Presenter

Presenter -> Service: GetStoredToken()
activate Service
Service --> Presenter: DPAPI-decrypted token (or null)
deactivate Service

alt No Token
    Presenter -> Service: InitiateDeviceFlow()
    activate Service
    Service -> GH: POST /login/device/code
    GH --> Service: device_code, user_code, verification_uri
    Service --> Presenter: DeviceFlowResponse
    deactivate Service
    
    Presenter -> User: Show user_code & verification_uri
    
    loop Poll until authorized
        Presenter -> Service: PollForToken(deviceCode)
        activate Service
        Service -> GH: POST /login/oauth/access_token
        GH --> Service: access_token (or pending)
        Service --> Presenter: TokenData (or null)
        deactivate Service
    end
    
    Presenter -> Service: SaveToken(tokenData)
    activate Service
    Service --> Presenter: (saved with DPAPI)
    deactivate Service
end

Presenter -> Service: GetLatestRelease(token)
activate Service
Service -> GH: GET /repos/.../releases/latest
GH --> Service: Release JSON (tag, assets)
Service --> Presenter: Release object
deactivate Service

Presenter -> Service: GetLocalVersion()
activate Service
Service --> Presenter: local version
deactivate Service

Presenter -> Presenter: Compare versions

alt Update Available
    Presenter -> User: Show update prompt
    User --> Presenter: Confirm update
    
    Presenter -> Service: GetReleaseAsset(release, "*.msi")
    activate Service
    Service --> Presenter: MSI asset info
    deactivate Service
    
    Presenter -> Service: DownloadAsset(token, asset, destDir)
    activate Service
    Service -> GH: Download MSI
    GH --> Service: MSI file
    Service --> Presenter: Local MSI path
    deactivate Service
    
    Presenter -> Service: VerifyFileHash(path, expectedHash)
    activate Service
    note right: SHA-256 verification
    Service --> Presenter: true/false
    deactivate Service
    
    Presenter -> Service: ApplyUpdate(msiPath, false, sourceRoot)
    activate Service
    
    Service -> Worker: Start-Process pwsh -File InstallWorker.ps1
    activate Worker
    
    Worker -> Worker: Stop-Process "DONUT" (graceful)
    Worker -> Worker: msiexec /i "NewVersion.msi" /passive
    Worker -> Worker: Start-Process "Donut.Launcher.exe"
    
    deactivate Worker
    deactivate Service
    
    destroy Presenter
    note over Presenter: App restarts with new version
    
else No Update Available
    Presenter -> User: Show "Already up to date"
end

deactivate Presenter
@enduml
